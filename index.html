<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pad 文档扫描器（A4 自动识别与高清扫描）</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- 仅当服务端没有设置更严格的 CSP 响应头时，这个 meta 才生效。
       若你的托管（如公司网关）已通过响应头设置了 CSP，请用 _headers/vercel.json 改响应头。 -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://unpkg.com 'unsafe-eval' 'wasm-unsafe-eval' blob: data:;
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: blob:;
          connect-src 'self' https://unpkg.com blob:;
          worker-src 'self' blob:;
        ">

  <script>
    /* 对不使用 wasm 的 OpenCV 构建无副作用；若有 wasm，会从同目录加载 */
    window.Module = { locateFile: (path) => './' + path };
  </script>

  <!-- 本地 OpenCV.js：必须在 app.js 之前且不要 async，避免初始化竞态 -->
  <script src="./opencv.js"></script>

  <!-- 方案1：通过 CDN 加载 Tesseract.js（用于文字方向校正 OSD） -->
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <!-- 应用逻辑：defer 等待 DOM 就绪 -->
  <script src="./app.js" defer></script>
</head>
<body>
  <header>
    <h1>Pad 文档扫描器</h1>
    <p>自动识别倾斜 A4、精准定位并生成高清扫描件</p>
  </header>

  <main>
    <section class="camera-section">
      <div class="video-wrapper">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="overlay" class="overlay"></canvas>
        <div id="status" class="status">初始化中…</div>
      </div>

      <div class="controls">
        <button id="startBtn">启动相机</button>
        <button id="snapBtn" disabled>手动拍摄</button>

        <!-- 上传图片 -->
        <label class="upload">
          <input type="file" id="fileInput" accept="image/*" />
          <span class="upload-btn">上传图片生成扫描件</span>
        </label>

        <label class="toggle">
          <input type="checkbox" id="autoCapture" checked />
          <span>自动抓拍（检测到稳定 A4）</span>
        </label>

        <label class="toggle">
          <input type="checkbox" id="textOrientationFix" checked />
          <span>文字方向校正</span>
        </label>

        <div class="options">
          <label>
            增强模式：
            <select id="enhanceMode">
              <option value="auto" selected>自动（推荐）</option>
              <option value="binarize">纯黑白（阈值）</option>
              <option value="color">保留彩色</option>
            </select>
          </label>
          <label>
            输出分辨率：
            <select id="outputSize">
              <option value="m">中（约 1600×2300）</option>
              <option value="h" selected>高（约 2400×3400）</option>
              <option value="uh">超高（约 3300×4700）</option>
            </select>
          </label>
        </div>

        <!-- 手动旋转（兜底控制） -->
        <div class="options">
          <button id="rotateLeftBtn">左转90°</button>
          <button id="rotateRightBtn">右转90°</button>
          <button id="rotate180Btn">旋转180°</button>
        </div>
      </div>
    </section>

    <section class="result-section">
      <h2>扫描结果</h2>
      <div class="result-wrapper">
        <canvas id="resultCanvas"></canvas>
      </div>
      <div class="result-actions">
        <button id="downloadPng" disabled>下载 PNG</button>
        <button id="downloadJpg" disabled>下载 JPG</button>
      </div>
    </section>

    <section class="tips">
      <h2>使用提示</h2>
      <ul>
        <li>将 A4 纸置于纯色背景，避免与背景同色以提升识别稳定性。</li>
        <li>保持充足光照，避免强反光；系统会自动做光照均衡处理。</li>
        <li>如出现横向或倒置，系统会自动矫正；也可使用手动旋转按钮一键修正。</li>
      </ul>
    </section>
  </main>

  <footer>
    <small>© 2026 文档扫描演示 · 基于 OpenCV.js & Tesseract.js</small>
  </footer>
</body>
</html>
