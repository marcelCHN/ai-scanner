<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 高清扫描 - 专业模式</title>
    <style>
        body { margin: 0; background: #1a1a1a; font-family: system-ui; color: white; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #stage { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
        video, canvas { max-width: 95%; max-height: 95%; position: absolute; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #canvasOutput { display: none; z-index: 10; background: white; }
        .status-bar { position: fixed; top: 15px; width: 100%; text-align: center; z-index: 100; }
        .badge { background: rgba(0, 122, 255, 0.8); color: white; padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .controls { height: 110px; background: rgba(0,0,0,0.9); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .btn { background: none; border: none; color: white; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; opacity: 0.5; pointer-events: none; }
        .btn.ready { opacity: 1; pointer-events: auto; }
        .shutter { width: 64px; height: 64px; background: white; border-radius: 50%; border: 4px solid #555; transition: 0.2s; }
        .shutter:active { transform: scale(0.9); background: #ddd; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="status-bar"><span class="badge" id="msg">正在同步 AI 核心...</span></div>

<div id="stage">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvasOutput"></canvas>
</div>

<div class="controls">
    <button class="btn" id="btn-import" onclick="document.getElementById('fileInput').click()">
        <div style="width:24px; height:24px; border:2px solid white; border-radius:4px;"></div>
        <span>导入照片</span>
    </button>
    <input type="file" id="fileInput" accept="image/*">

    <button class="btn" id="btn-snap" onclick="capture()">
        <div class="shutter"></div>
        <span>拍照扫描</span>
    </button>

    <button class="btn ready" onclick="location.reload()">
        <div style="width:24px; height:24px; border:2px solid white; border-radius:50%; border-top-color:transparent;"></div>
        <span>重置</span>
    </button>
</div>

<script>
    var Module = { onRuntimeInitialized() { 
        document.getElementById('msg').innerText = "AI 扫描就绪"; 
        document.querySelectorAll('.btn').forEach(b => b.classList.add('ready'));
        startCam(); 
    }};

    async function startCam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280 } });
            document.getElementById('video').srcObject = stream;
        } catch (e) { document.getElementById('msg').innerText = "相机不可用，请导入"; }
    }

    // 严谨的四点排序算法
    function sortPoints(pts) {
        const sorted = new Array(4);
        const sums = pts.map(p => p.x + p.y);
        const diffs = pts.map(p => p.y - p.x);
        sorted[0] = pts[sums.indexOf(Math.min(...sums))]; // TL
        sorted[1] = pts[diffs.indexOf(Math.min(...diffs))]; // TR
        sorted[2] = pts[sums.indexOf(Math.max(...sums))]; // BR
        sorted[3] = pts[diffs.indexOf(Math.max(...diffs))]; // BL
        return sorted;
    }

    function processImage(source) {
        let src = cv.imread(source);
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        
        // 1. 寻找边界
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
        cv.Canny(gray, gray, 75, 200);

        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let maxArea = 0, bestPts = null;
        for (let i = 0; i < contours.size(); ++i) {
            let cnt = contours.get(i);
            let peri = cv.arcLength(cnt, true);
            let approx = new cv.Mat();
            cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
            if (approx.rows == 4) {
                let area = cv.contourArea(approx);
                if (area > maxArea) {
                    maxArea = area;
                    bestPts = [];
                    for (let j = 0; j < 4; j++) bestPts.push({ x: approx.data32S[j * 2], y: approx.data32S[j * 2 + 1] });
                }
            }
            approx.delete();
        }

        const outW = 1000, outH = 1414; // A4 比例
        let warped = new cv.Mat();

        // 2. 如果没识别到，强制生成默认四点进行“微校正”
        if (!bestPts || maxArea < (src.rows * src.cols * 0.05)) {
            const marginX = src.cols * 0.05;
            const marginY = src.rows * 0.05;
            bestPts = [
                {x: marginX, y: marginY}, {x: src.cols - marginX, y: marginY},
                {x: src.cols - marginX, y: src.rows - marginY}, {x: marginX, y: src.rows - marginY}
            ];
        }

        let sorted = sortPoints(bestPts);
        let srcCoords = cv.matFromArray(4, 1, cv.CV_32FC2, [sorted[0].x, sorted[0].y, sorted[1].x, sorted[1].y, sorted[2].x, sorted[2].y, sorted[3].x, sorted[3].y]);
        let dstCoords = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, outW, 0, outW, outH, 0, outH]);
        let M = cv.getPerspectiveTransform(srcCoords, dstCoords);
        cv.warpPerspective(src, warped, M, new cv.Size(outW, outH));

        // 3. 扫描件画质增强（不使用素描二值化）
        let enhanced = new cv.Mat();
        // 提升对比度和亮度：Alpha=1.2 (对比度), Beta=10 (亮度)
        warped.convertTo(enhanced, -1, 1.2, 10);
        
        // 可选：轻微锐化让文字更清晰
        let blurred = new cv.Mat();
        cv.GaussianBlur(enhanced, blurred, new cv.Size(0, 0), 3);
        cv.addWeighted(enhanced, 1.5, blurred, -0.5, 0, enhanced);

        let canvas = document.getElementById('canvasOutput');
        canvas.style.display = 'block';
        cv.imshow('canvasOutput', enhanced);
        
        // 释放
        src.delete(); dst.delete(); gray.delete(); warped.delete(); enhanced.delete(); blurred.delete(); 
        srcCoords.delete(); dstCoords.delete(); M.delete(); contours.delete(); hierarchy.delete();
        document.getElementById('msg').innerText = "扫描完成 (长按图片可保存)";
    }

    function capture() { processImage(document.getElementById('video')); }
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => processImage(img);
            img.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
<script async src="opencv.js"></script>
</body>
</html>
